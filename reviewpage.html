<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Camp Reviews | Jay Ambe Seva Kendra USA CAMP</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- EmailJS: load as global (do NOT import as ES module) -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #2d044d 0%, #111827 60%, #fde68a 100%);
      min-height: 100vh;
      font-family: 'Poppins', Arial, sans-serif;
      color: #e0e0e0;
    }
    .mystic-text { background: linear-gradient(90deg, #9d00ff 0%, #fde68a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .glow { text-shadow: 0 2px 12px #9d00ff66, 0 0 1px #fde68a99; }
    .review-card { background: rgba(34,24,54,0.95); color:#fde68a; border-radius:1.2rem; box-shadow:0 8px 32px #9d00ff22; padding:2rem 1.5rem; margin-bottom:2rem; transition: transform .4s, box-shadow .4s; transform-style: preserve-3d; }
    .btn-mystic { background: linear-gradient(90deg,#9d00ff 0%,#fde68a 100%); color:#fff8dc; border-radius:9999px; padding:.65rem 1.4rem; font-weight:600; box-shadow:0 4px 24px #9d00ff33; }
    .star { width:1.7em; height:1.7em; display:inline-block; vertical-align:middle; margin-right:.08em; filter: drop-shadow(0 2px 4px #fde68a88); }
    .star svg { display:block; }
    .star.filled svg path { fill: url(#star-gradient); stroke:#b45309; stroke-width:1.2; }
    .star.empty svg path { fill:#e5e7eb; stroke:#b45309; stroke-width:1.2; }
    .overall-rating-value { font-size:2.2rem; font-weight:900; color:#7c2dff; margin-left:.5rem; }
    .main-container { background: rgba(20,20,40,0.7); border-radius:2rem; box-shadow:0 8px 32px #9d00ff33; padding:2.5rem 1.5rem; margin-top:2rem; margin-bottom:2rem; }
    .review-form input, .review-form textarea { border-radius:.75rem; border:2px solid #c084fc; padding:.75rem 1rem; font-size:1rem; margin-bottom:1rem; width:100%; background:#f3e8ff; color:#3b0764; }
    @media (max-width:767px) { .main-container { padding:1.2rem .5rem; } .reviewpage-title { font-size:1.3rem; } .overall-rating-value { font-size:1.3rem; } }
    #photo-modal { display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,.9); align-items:center; justify-content:center; }
    #photo-modal img { max-width:90vw; max-height:90vh; border-radius:1rem; box-shadow:0 4px 32px #fde68a88; }
  </style>
</head>
<body>
  <nav class="flex justify-end items-center px-6 py-4 relative">
    <div id="user-menu-container" class="relative">
      <div id="greeting-container" class="flex items-center bg-white rounded-full px-4 py-2 shadow mr-4" style="min-width:160px; display:none;">
        <span id="user-greeting" class="text-purple-800 font-bold cursor-pointer"></span>
        <svg class="w-4 h-4 ml-2 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </div>
      <div id="user-menu" class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg py-2 z-50 hidden">
        <button id="change-name-btn" class="block w-full text-left px-4 py-2 hover:bg-purple-100 text-purple-900 font-semibold">Change Name</button>
        <button id="sign-out-btn" class="block w-full text-left px-4 py-2 hover:bg-purple-100 text-purple-900 font-semibold">Sign Out</button>
        <button id="logout-btn" class="block w-full text-left px-4 py-2 hover:bg-purple-100 text-purple-900 font-semibold">Log Out</button>
        <button id="delete-account-btn" class="block w-full text-left px-4 py-2 hover:bg-red-100 text-red-700 font-semibold">Delete Account</button>
        <button id="admin-logout-btn" class="block w-full text-left px-4 py-2 hover:bg-red-100 text-red-700 font-semibold">Admin Logout</button>
      </div>
    </div>
    <a href="signin.html" id="sign-in-btn" class="btn-mystic mr-2"><span>Sign In</span></a>
    <a href="signup.html" id="sign-up-btn" class="btn-mystic mr-2"><span>Sign Up</span></a>
    <!-- Admin code login button is injected by script if not already an admin -->
  </nav>

  <!-- background & defs -->
  <video id="bgVideo" autoplay loop muted playsinline class="fixed top-0 left-0 w-full h-full object-cover z-[-2]" style="min-width:100vw; min-height:100vh; pointer-events:none;">
    <source src="back-ground.mp4" type="video/mp4">
  </video>
  <div id="bgOverlay" class="fixed top-0 left-0 w-full h-full z-[-1]" style="background:rgba(20,20,40,0.65);"></div>

  <svg width="0" height="0" style="position:absolute;">
    <defs>
      <linearGradient id="star-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#fde68a"/>
        <stop offset="100%" stop-color="#fbbf24"/>
      </linearGradient>
    </defs>
  </svg>

  <header class="text-center py-10">
    <h1 class="text-5xl font-extrabold mystic-text glow mb-2">Camp Reviews</h1>
    <div class="reviewpage-title">It's Review Page</div>

    <div class="flex flex-col items-center gap-2 mb-4">
      <div class="flex items-center justify-center gap-2 text-3xl font-bold mystic-text glow animate-pulse" style="perspective:600px;">
        <span class="review-stars" id="overall-stars"></span>
        <span class="overall-rating-value" id="overall-value">4.9</span>
        <span class="text-lg text-gray-700 font-semibold">out of 5</span>
      </div>
      <div class="trusted-badge px-6 py-2 rounded-full font-bold text-white shadow-lg" style="background:linear-gradient(90deg,#9d00ff 0%,#fde68a 100%);">
        <span class="text-yellow-200">Trusted by 1.25 crore (12.5 million)+ people from 25 years</span>
      </div>
    </div>
  </header>

  <main class="max-w-2xl mx-auto px-4 main-container">
    <section id="reviews-list">
      <!-- Static seed reviews (unchanged) -->
      <div class="review-card" data-rating="5" data-review-id="static-1">
        <div class="flex items-center mb-2">
          <span class="review-stars static-stars"></span>
          <span class="font-bold">Aarti j. patel</span>
        </div>
        <p class="review-text">camp was a life-changing experience! The seva, food, and Garba were all amazing. maja avi gai mittro Jai Ambe Maa!</p>
        <div class="text-sm">September 2024</div>
      </div>

      <div class="review-card" data-rating="5" data-review-id="static-2">
        <div class="flex items-center mb-2">
          <span class="review-stars static-stars"></span>
          <span class="font-bold">Ramesh K.</span>
        </div>
        <p class="review-text">Very well organized and full of positive energy. My family loved every moment. Thank you!</p>
        <div class="text-sm">September 2023</div>
      </div>

      <div class="review-card" data-rating="5" data-review-id="static-3">
        <div class="flex items-center mb-2">
          <span class="review-stars static-stars"></span>
          <span class="font-bold">Hardik Sharma</span>
        </div>
        <p class="review-text">the camp was so amazing! The seva, food, and Garba were all amazing. maja avi gai mittro Jai Ambe Maa!</p>
        <div class="text-sm">September 2022</div>
      </div>
    </section>

    <div id="photo-modal"><img id="photo-modal-img" src="" alt=""></div>

    <section class="mt-10 mb-20" id="review-form-section">
      <h2 class="text-2xl font-bold mystic-text mb-4">Leave Your Review</h2>

      <form id="review-form" class="review-form bg-white bg-opacity-80 p-6 rounded-xl shadow-lg" novalidate>
        <input type="text" id="name" placeholder="Your Name" required>
        <textarea id="review" rows="4" placeholder="Your Review" required></textarea>

        <div class="mb-4">
          <label class="block mb-1 font-semibold text-purple-700">Rating:</label>
          <select id="rating" required class="w-full border-2 border-purple-300 rounded-lg p-2 bg-white text-purple-900 mb-2">
            <option value="" disabled selected>Select rating</option>
            <option value="5">⭐⭐⭐⭐⭐ 5 - Excellent</option>
            <option value="4">⭐⭐⭐⭐ 4 - Good</option>
            <option value="3">⭐⭐⭐ 3 - Average</option>
            <option value="2">⭐⭐ 2 - Poor</option>
            <option value="1">⭐ 1 - Terrible</option>
          </select>

          <label class="block mb-1 font-semibold text-purple-700">Add a Photo (optional):</label>
          <input type="file" id="photo" accept="image/*" class="w-full border-2 border-purple-300 rounded-lg p-2 bg-white text-purple-900">
        </div>

        <button type="submit" class="btn-mystic w-full">Submit Review</button>
      </form>

      <!-- Keep extra JS button but ensure it does not submit form twice -->
      <button id="submitReview" type="button" class="btn-mystic w-full mt-2">Submit Review (JS Button)</button>

      <p id="reviewFormMessage" class="text-center text-red-500 mt-2"></p>
    </section>
  </main>

  <footer class="bg-gradient-to-r from-purple-900/90 via-gray-900/80 to-yellow-900/70 py-10 border-t border-yellow-300/30 text-center mt-16 text-yellow-200 space-y-6">
    <div>&copy; 2025 Jay Ambe Seva Kendra USA. All rights reserved.</div>
    <div class="text-sm">Designed with ❤️ by <strong>Abhi's Development Team</strong></div>
    <div>
      <a href="https://www.instagram.com/jay_ambe_seva_kendra_usa_camp" target="_blank" class="inline-flex items-center gap-2 hover:text-yellow-300 transition">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5" viewBox="0 0 24 24">
          <path d="M7.75 2h8.5A5.75 5.75 0 0 1 22 7.75v8.5A5.75 5.75 0 0 1 16.25 22h-8.5A5.75 5.75 0 0 1 2 16.25v-8.5A5.75 5.75 0 0 1 7.75 2zm0 1.5A4.25 4.25 0 0 0 3.5 7.75v8.5A4.25 4.25 0 0 0 7.75 20.5h8.5A4.25 4.25 0 0 0 20.5 16.25v-8.5A4.25 4.25 0 0 0 16.25 3.5h-8.5zM12 7a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 1.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zM17.25 7.12a.88.88 0 1 1 0 1.75.88.88 0 0 1 0-1.75z"/>
        </svg>
        Follow us on Instagram
      </a>
    </div>
    <div>
      <a href="mailto:jayambesevausacamp.org@gmail.com?subject=Support%20Request" class="inline-block bg-yellow-300 text-purple-900 font-semibold px-5 py-2 rounded-full hover:bg-yellow-400 transition">📧 Need Help? Email Us</a>
      <p class="mt-2 text-sm text-yellow-100">
        <span class="underline">jayambesevausacamp.org@gmail.com</span><br>
        Response time: 1 hour to 5 days<br>
        Support hours: Monday to Friday 12 PM to 5 PM EST
      </p>
    </div>
  </footer>

  <!-- Firebase + app logic (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase config (yours)
    const firebaseConfig = {
      apiKey: "AIzaSyBcg_KDuRX7pr8_ah4oGmNqa8JTsmYHXGM",
      authDomain: "jay-ambe-serva-kendra-usa-camp.firebaseapp.com",
      projectId: "jay-ambe-serva-kendra-usa-camp",
      storageBucket: "jay-ambe-serva-kendra-usa-camp.appspot.com",
      messagingSenderId: "60678468849",
      appId: "1:60678468849:web:0ada18006b3d18e8ef6550",
      measurementId: "G-VDZ5LFS1P5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ===== Admin settings =====
    const ADMIN_EMAIL = "jayambesevausacamp.org@gmail.com"; // Firebase-auth admin
    const ADMIN_CODE = "2822990904"; // your secret code
    const ADMIN_CODE_HASH_KEY = "__JASK_ADMIN_CODE_SHA256"; // localStorage key for hash (fixed)
    const ADMIN_SESSION_KEY = "__JASK_isAdminSession";      // bool flag
    const ADMIN_EXP_KEY = "__JASK_isAdminSession_exp";      // expiry timestamp (ms)
    const ADMIN_SESSION_TTL_MS = 7 * 24 * 60 * 60 * 1000;   // 7 days

    // Pre-compute and persist a SHA-256 hash of your code (so code itself is never stored)
    async function sha256(text) {
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest('SHA-256', enc.encode(text));
      const hashArray = Array.from(new Uint8Array(buf));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function ensureAdminHash() {
      // compute once per device (not security, just hiding plain text)
      const existing = localStorage.getItem(ADMIN_CODE_HASH_KEY);
      if (!existing) {
        const h = await sha256(ADMIN_CODE);
        localStorage.setItem(ADMIN_CODE_HASH_KEY, h);
      }
    }

    function nowMs() { return Date.now(); }

    function isAdminSessionActive() {
      const v = localStorage.getItem(ADMIN_SESSION_KEY) === 'true';
      const exp = parseInt(localStorage.getItem(ADMIN_EXP_KEY) || '0', 10);
      if (!v) return false;
      if (!exp || nowMs() > exp) {
        // expired
        localStorage.removeItem(ADMIN_SESSION_KEY);
        localStorage.removeItem(ADMIN_EXP_KEY);
        return false;
      }
      return true;
    }

    async function adminCodeLogin() {
      await ensureAdminHash();
      const input = prompt("Enter admin code:");
      if (!input) return;
      const inputHash = await sha256(input.trim());
      const savedHash = localStorage.getItem(ADMIN_CODE_HASH_KEY);
      if (inputHash === savedHash) {
        localStorage.setItem(ADMIN_SESSION_KEY, 'true');
        localStorage.setItem(ADMIN_EXP_KEY, String(nowMs() + ADMIN_SESSION_TTL_MS));
        alert("Admin mode enabled! You can now delete, pin, reply, and edit any review.");
        // Broadcast to other tabs
        localStorage.setItem('__JASK_admin_sync', String(Math.random()));
        window.location.reload();
      } else {
        alert("Incorrect admin code.");
      }
    }

    function adminCodeLogout() {
      localStorage.removeItem(ADMIN_SESSION_KEY);
      localStorage.removeItem(ADMIN_EXP_KEY);
      localStorage.setItem('__JASK_admin_sync', String(Math.random()));
      alert('Admin mode disabled on this browser.');
      window.location.reload();
    }

    // ===== Utilities =====
    function escapeHTML(str) {
      return (str || "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" })[m]);
    }

    function formatDate(ts) {
      if (!ts) return "";
      // Handle Firestore Timestamp, {seconds,nanoseconds}, Date, or number
      let d;
      if (typeof ts === 'object' && ts.seconds) {
        d = new Date(ts.seconds * 1000);
      } else if (ts instanceof Date) {
        d = ts;
      } else if (typeof ts === 'number') {
        d = new Date(ts);
      } else {
        return '';
      }
      return d.toLocaleString(undefined, { year: "numeric", month: "long", day: "numeric" });
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function renderStars(container, rating) {
      container.innerHTML = '';
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.className = 'star ' + (i <= rating ? 'filled' : 'empty');
        star.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 3.5l3.09 6.26 6.91.99-5 4.87 1.18 6.88L12 18.77l-6.18 3.25L7 15.62l-5-4.87 6.91-.99z"/></svg>`;
        container.appendChild(star);
      }
    }

    // ===== State refs =====
    let reviewForm, reviewsList, photoModal, photoModalImg, reviewFormMessage, overallStars, overallValue;
    let currentUser = null;
    let isAdminByEmail = false; // Firebase-auth based admin

    // ===== EmailJS wrappers =====
    let emailjsInitialized = false;
    function initEmailJS() {
      if (emailjsInitialized) return;
      if (!window.emailjs) return;
      emailjs.init('vWtiu7fYv11u1QEjZ'); // your public key
      emailjsInitialized = true;
    }

    function isValidEmail(e){ return /.+@.+\..+/.test(e || ''); }

    function sendEmailNotification(name, message, rating) {
      if (!window.emailjs) return;
      initEmailJS();
      emailjs.send('service_n0xsyoo', 'template_rs1dlxp', {
        to_email: 'jayambesevausacamp.org@gmail.com',
        from_name: name || 'Anonymous',
        review_text: message || '',
        review_rating: String(rating || '')
      }).catch(err => console.warn('EmailJS send error', err));
    }

    function sendAdminReplyNotification(userEmail, replyText, userName, reviewText) {
      if (!window.emailjs) return;
      if (!isValidEmail(userEmail)) return; // avoid "address corrupted" errors
      initEmailJS();
      emailjs.send('service_n0xsyoo', 'template_6w2xw7g', {
        to_email: userEmail,
        user_name: userName || 'Friend',
        review_text: reviewText || '',
        admin_reply: replyText || ''
      }).then(() => {
        alert('Reply sent and notification delivered!');
      }).catch(err => {
        alert('Reply saved, but notification failed: ' + (err?.message || err));
      });
    }

    // ===== Review card =====
    function makeReviewCard(data, pinned = false) {
      const card = document.createElement('div');
      card.className = 'review-card mb-4';
      card.setAttribute('data-review-id', data.id || '');

      const nameLine = document.createElement('div');
      nameLine.className = 'flex items-center mb-2';
      const nameSpan = document.createElement('span');
      nameSpan.className = 'font-bold';
      nameSpan.innerText = data.name || 'Anonymous';
      nameLine.appendChild(nameSpan);

      if (pinned) {
        const pinBadge = document.createElement('span');
        pinBadge.className = 'ml-2 px-2 py-1 bg-yellow-400 text-purple-900 rounded-full text-xs font-bold';
        pinBadge.innerText = 'Pinned';
        nameLine.appendChild(pinBadge);
      }

      const starsContainer = document.createElement('div');
      starsContainer.className = 'review-stars mb-2';
      renderStars(starsContainer, data.rating || 5);

      const msg = document.createElement('p');
      msg.className = 'review-text mb-2';
      msg.innerText = data.message || '';

      const dateDiv = document.createElement('div');
      dateDiv.className = 'text-sm text-purple-200';
      dateDiv.innerText = formatDate(data.timestamp);

      card.appendChild(nameLine);
      card.appendChild(starsContainer);
      card.appendChild(msg);

      if (data.adminReply) {
        const replyDiv = document.createElement('div');
        replyDiv.className = 'bg-purple-100 text-purple-900 rounded-lg px-4 py-2 mt-2 mb-2 border-l-4 border-yellow-400';
        replyDiv.innerHTML = `<strong>Admin Reply:</strong> ${escapeHTML(data.adminReply)}`;
        card.appendChild(replyDiv);
      }

      if (data.imageURL) {
        const wrap = document.createElement('div');
        wrap.className = 'mb-2';
        const img = document.createElement('img');
        img.src = data.imageURL;
        img.alt = 'Review photo';
        img.style.maxWidth = '120px';
        img.style.maxHeight = '120px';
        img.style.borderRadius = '0.7rem';
        img.style.boxShadow = '0 2px 12px #9d00ff44';
        img.style.cursor = 'pointer';
        img.onclick = () => {
          photoModalImg.src = data.imageURL;
          photoModal.style.display = 'flex';
        };
        wrap.appendChild(img);
        card.appendChild(wrap);
      }

      card.appendChild(dateDiv);

      // Controls (edit/delete/pin/reply)
      const controls = document.createElement('div');
      controls.className = 'flex gap-2 mt-2';
      const isAdminSession = isAdminSessionActive();

      if ((currentUser && (currentUser.uid === data.userId || isAdminByEmail)) || isAdminSession) {
        const editBtn = document.createElement('button');
        editBtn.className = 'btn-mystic px-4 py-1 text-sm';
        editBtn.innerText = 'Edit';
        editBtn.onclick = async () => {
          const currentText = msg.textContent;
          const newText = prompt('Edit your review:', currentText);
          if (newText && newText !== currentText) {
            await updateDoc(doc(db, 'reviews', data.id), { message: newText });
            await renderReviews();
          }
        };
        controls.appendChild(editBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-mystic px-4 py-1 text-sm';
        delBtn.style.background = 'linear-gradient(90deg,#ff1744 0%,#fde68a 100%)';
        delBtn.style.color = '#fff';
        delBtn.innerText = 'Delete';
        delBtn.onclick = async () => {
          if (confirm('Are you sure you want to delete this review?')) {
            await deleteDoc(doc(db, 'reviews', data.id));
            await renderReviews();
          }
        };
        controls.appendChild(delBtn);
      }

      if (isAdminByEmail || isAdminSession) {
        const pinBtn = document.createElement('button');
        pinBtn.className = 'btn-mystic px-4 py-1 text-sm';
        pinBtn.style.background = 'linear-gradient(90deg,#fde68a 0%,#9d00ff 100%)';
        pinBtn.style.color = '#7c2dff';
        pinBtn.textContent = data.isPinned ? 'Unpin' : 'Pin';
        pinBtn.onclick = async () => {
          const snap = await getDocs(collection(db, 'reviews'));
          for (const s of snap.docs) {
            if (s.data().isPinned) await updateDoc(doc(db, 'reviews', s.id), { isPinned: false });
          }
          await updateDoc(doc(db, 'reviews', data.id), { isPinned: !data.isPinned });
          await renderReviews();
        };
        controls.appendChild(pinBtn);

        const replyBtn = document.createElement('button');
        replyBtn.className = 'btn-mystic px-4 py-1 text-sm';
        replyBtn.style.background = 'linear-gradient(90deg,#fde68a 0%,#7c2dff 100%)';
        replyBtn.style.color = '#fff';
        replyBtn.textContent = 'Reply';
        replyBtn.onclick = async () => {
          const replyText = prompt('Reply to this review:', data.adminReply || '');
          if (replyText && replyText.trim()) {
            await updateDoc(doc(db, 'reviews', data.id), { adminReply: replyText.trim() });
            await renderReviews();
            const notifyEmail = data.userEmail; // set at submit time
            if (notifyEmail) {
              sendAdminReplyNotification(notifyEmail, replyText.trim(), data.name, data.message);
            }
          }
        };
        controls.appendChild(replyBtn);
      }

      card.appendChild(controls);
      return card;
    }

    // ===== Render reviews =====
    async function renderReviews() {
      const staticReviews = Array.from(reviewsList.querySelectorAll('.review-card[data-review-id^="static-"]'));
      reviewsList.innerHTML = '';
      staticReviews.forEach(c => reviewsList.appendChild(c));

      try {
        const qy = query(collection(db, 'reviews'), orderBy('timestamp', 'desc'));
        const snap = await getDocs(qy);
        const reviews = [];
        snap.forEach(s => reviews.push({ ...s.data(), id: s.id }));

        const pinned = reviews.find(r => r.isPinned);
        if (pinned) reviewsList.appendChild(makeReviewCard(pinned, true));
        reviews.filter(r => !r.isPinned).forEach(r => reviewsList.appendChild(makeReviewCard(r, false)));

        // overall rating
        let total = 0, count = 0;
        staticReviews.forEach(card => {
          const r = parseInt(card.getAttribute('data-rating') || '0', 10);
          if (r > 0) { total += r; count++; }
        });
        reviews.forEach(r => { if (r.rating) { total += r.rating; count++; } });
        const avg = count ? (total / count) : 0;
        overallValue.innerText = avg ? avg.toFixed(1) : '0.0';
        renderStars(overallStars, Math.round(avg));
      } catch (e) {
        console.warn('Failed loading reviews', e);
      }
    }

    // ===== DOM Ready =====
    document.addEventListener('DOMContentLoaded', async () => {
      await ensureAdminHash();

      // Inject Admin Login button if not active
      if (!isAdminSessionActive()) {
        const nav = document.querySelector('nav');
        if (nav) {
          const adminBtn = document.createElement('button');
          adminBtn.textContent = 'Admin Login';
          adminBtn.className = 'btn-mystic ml-2';
          adminBtn.addEventListener('click', adminCodeLogin);
          nav.appendChild(adminBtn);
        }
      }

      // element refs
      reviewForm = document.getElementById('review-form');
      reviewsList = document.getElementById('reviews-list');
      photoModal = document.getElementById('photo-modal');
      photoModalImg = document.getElementById('photo-modal-img');
      reviewFormMessage = document.getElementById('reviewFormMessage');
      overallStars = document.getElementById('overall-stars');
      overallValue = document.getElementById('overall-value');

      // render static stars
      document.querySelectorAll('.review-card').forEach(card => {
        const r = parseInt(card.getAttribute('data-rating') || '5', 10);
        const sc = card.querySelector('.static-stars') || card.querySelector('.review-stars');
        if (sc) renderStars(sc, r);
      });

      // Submit handler (used by form submit & JS button)
      async function submitHandler(e) {
        if (e) e.preventDefault();
        const name = (document.getElementById('name').value || 'Anonymous').trim();
        const message = (document.getElementById('review').value || '').trim();
        const rating = parseInt(document.getElementById('rating').value || '0', 10);
        const photoInput = document.getElementById('photo');
        let imageURL = '';
        let userEmail = currentUser ? currentUser.email : '';

        if (!message) {
          reviewFormMessage.style.color = 'red';
          reviewFormMessage.textContent = 'Please write a review.';
          return;
        }
        if (!rating || rating < 1 || rating > 5) {
          reviewFormMessage.style.color = 'red';
          reviewFormMessage.textContent = 'Please select rating.';
          return;
        }

        if (photoInput && photoInput.files && photoInput.files[0]) {
          try { imageURL = await toBase64(photoInput.files[0]); } catch (err) { console.warn('Image read failed', err); }
        }

        try {
          await addDoc(collection(db, 'reviews'), {
            name, message, rating, imageURL,
            isPinned: false,
            timestamp: serverTimestamp(), // use Firestore server time
            userId: currentUser ? currentUser.uid : null,
            userEmail: userEmail || null
          });

          sendEmailNotification(name, message, rating);

          reviewForm.reset();
          reviewFormMessage.style.color = 'green';
          reviewFormMessage.textContent = 'Review submitted successfully!';
          setTimeout(()=> reviewFormMessage.textContent = '', 3000);

          await renderReviews();
        } catch (err) {
          console.error('Submit error', err);
          reviewFormMessage.style.color = 'red';
          reviewFormMessage.textContent = 'Error submitting review: ' + (err.message || err);
        }
      }

      if (reviewForm) reviewForm.addEventListener('submit', submitHandler);
      const jsBtn = document.getElementById('submitReview');
      if (jsBtn) jsBtn.addEventListener('click', submitHandler);

      if (photoModal) photoModal.onclick = () => { photoModal.style.display = 'none'; photoModalImg.src = ''; };

      // User menu & admin logout
      const userGreeting = document.getElementById('user-greeting');
      const greetingContainer = document.getElementById('greeting-container');
      const userMenu = document.getElementById('user-menu');
      const changeNameBtn = document.getElementById('change-name-btn');
      const deleteAccountBtn = document.getElementById('delete-account-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const adminLogoutBtn = document.getElementById('admin-logout-btn');

      if (greetingContainer) {
        greetingContainer.onclick = () => {
          if (currentUser || isAdminSessionActive()) {
            userMenu.style.display = userMenu.style.display === 'block' ? 'none' : 'block';
          }
        };
        document.addEventListener('click', (e) => {
          if (!greetingContainer.contains(e.target) && !userMenu.contains(e.target)) {
            userMenu.style.display = 'none';
          }
        });
      }

      if (changeNameBtn) {
        changeNameBtn.onclick = async () => {
          userMenu.style.display = 'none';
          if (!currentUser) return alert('Sign in to change name.');
          const newName = prompt('Enter your new display name:', currentUser.displayName || '');
          if (newName && newName.trim() && newName !== currentUser.displayName) {
            try {
              await updateProfile(currentUser, { displayName: newName.trim() });
              alert('Name updated!');
              userGreeting.textContent = `Hello, ${newName.trim()}`;
              renderReviews();
            } catch (err) {
              alert('Failed to update name: ' + (err.message || err));
            }
          }
        };
      }

      if (deleteAccountBtn) {
        deleteAccountBtn.onclick = async () => {
          userMenu.style.display = 'none';
          if (!currentUser) return alert('You are not signed in.');
          if (confirm('After you have deleted an account, it will be permanently deleted and cannot be recovered. Continue?')) {
            try {
              await deleteUser(currentUser);
              alert('Your account has been deleted permanently.');
              window.location.reload();
            } catch (err) {
              alert('Failed to delete account: ' + (err.message || err));
            }
          }
        };
      }

      if (logoutBtn) {
        logoutBtn.onclick = () => {
          userMenu.style.display = 'none';
          signOut(auth).catch(e => alert('Log out failed: '+e.message));
        };
      }

      if (adminLogoutBtn) {
        adminLogoutBtn.onclick = () => { userMenu.style.display = 'none'; adminCodeLogout(); };
      }

      // Sync admin session across tabs
      window.addEventListener('storage', (e) => {
        if (e.key === '__JASK_admin_sync') {
          // Another tab changed admin state; update greeting and controls
          updateGreeting();
          renderReviews();
        }
      });

      function updateGreeting() {
        const isAdminSession = isAdminSessionActive();
        if (currentUser) {
          isAdminByEmail = currentUser.email === ADMIN_EMAIL;
          const isAnyAdmin = isAdminByEmail || isAdminSession;
          userGreeting.textContent = isAnyAdmin ? 'Hello, admin' : `Hello, ${currentUser.displayName || 'user'}`;
          greetingContainer.style.display = '';
          document.getElementById('sign-in-btn').style.display = 'none';
          document.getElementById('sign-up-btn').style.display = 'none';
        } else {
          // Not signed in; but admin via code can still manage
          if (isAdminSession) {
            userGreeting.textContent = 'Hello, admin (code)';
            greetingContainer.style.display = '';
            document.getElementById('sign-in-btn').style.display = '';
            document.getElementById('sign-up-btn').style.display = '';
          } else {
            userGreeting.textContent = '';
            greetingContainer.style.display = 'none';
            document.getElementById('sign-in-btn').style.display = '';
            document.getElementById('sign-up-btn').style.display = '';
          }
        }
      }

      // Firebase auth listener
      onAuthStateChanged(auth, (user) => {
        currentUser = user || null;
        isAdminByEmail = user && user.email === ADMIN_EMAIL;
        updateGreeting();
        renderReviews();
      });

      // Initial render
      updateGreeting();
      renderReviews().catch(e => console.warn(e));
    });
  </script>
</body>
</html>